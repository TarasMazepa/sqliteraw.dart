name: sqlite-build.yml

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  sqlite-build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: mlugg/setup-zig@v2
      with:
        version: 0.14.1

    - name: Create build directories
      run: |
        mkdir -p build/linux-x86_64
        mkdir -p build/windows-x86_64
        mkdir -p build/macos-x86_64
        mkdir -p build/macos-aarch64

    # Linux x86_64 build
    - name: Compile SQLite for Linux x86_64 (shared library)
      run: |
        zig cc -target x86_64-linux-gnu \
          -shared \
          -O3 \
          -DSQLITE_ENABLE_FTS4 \
          -DSQLITE_ENABLE_FTS5 \
          -DSQLITE_ENABLE_RTREE \
          -DSQLITE_ENABLE_GEOPOLY \
          sqlite/sqlite3.c \
          -lpthread -ldl -lm \
          -o build/linux-x86_64/sqlite3.so

    - name: Compile SQLite for Linux x86_64 (executable)
      run: |
        zig cc -target x86_64-linux-gnu \
          -O3 \
          -DSQLITE_ENABLE_FTS4 \
          -DSQLITE_ENABLE_FTS5 \
          -DSQLITE_ENABLE_RTREE \
          -DSQLITE_ENABLE_GEOPOLY \
          sqlite/sqlite3.c sqlite/shell.c \
          -lpthread -ldl -lm \
          -o build/linux-x86_64/sqlite3

    # Windows x86_64 build
    - name: Compile SQLite for Windows x86_64 (shared library)
      run: |
        zig cc -target x86_64-windows-gnu \
          -shared \
          -O3 \
          -DSQLITE_ENABLE_FTS4 \
          -DSQLITE_ENABLE_FTS5 \
          -DSQLITE_ENABLE_RTREE \
          -DSQLITE_ENABLE_GEOPOLY \
          sqlite/sqlite3.c \
          -o build/windows-x86_64/sqlite3.dll

    - name: Compile SQLite for Windows x86_64 (executable)
      run: |
        zig cc -target x86_64-windows-gnu \
          -O3 \
          -DSQLITE_ENABLE_FTS4 \
          -DSQLITE_ENABLE_FTS5 \
          -DSQLITE_ENABLE_RTREE \
          -DSQLITE_ENABLE_GEOPOLY \
          sqlite/sqlite3.c sqlite/shell.c \
          -o build/windows-x86_64/sqlite3.exe

    # macOS x86_64 build
    - name: Compile SQLite for macOS x86_64 (shared library)
      run: |
        zig cc -target x86_64-macos-none \
          -shared \
          -O3 \
          -DSQLITE_ENABLE_FTS4 \
          -DSQLITE_ENABLE_FTS5 \
          -DSQLITE_ENABLE_RTREE \
          -DSQLITE_ENABLE_GEOPOLY \
          sqlite/sqlite3.c \
          -lpthread -ldl -lm \
          -o build/macos-x86_64/sqlite3.dylib

    - name: Compile SQLite for macOS x86_64 (executable)
      run: |
        zig cc -target x86_64-macos-none \
          -O3 \
          -DSQLITE_ENABLE_FTS4 \
          -DSQLITE_ENABLE_FTS5 \
          -DSQLITE_ENABLE_RTREE \
          -DSQLITE_ENABLE_GEOPOLY \
          sqlite/sqlite3.c sqlite/shell.c \
          -lpthread -ldl -lm \
          -o build/macos-x86_64/sqlite3

    # macOS ARM64 build
    - name: Compile SQLite for macOS ARM64 (shared library)
      run: |
        zig cc -target aarch64-macos-none \
          -shared \
          -O3 \
          -DSQLITE_ENABLE_FTS4 \
          -DSQLITE_ENABLE_FTS5 \
          -DSQLITE_ENABLE_RTREE \
          -DSQLITE_ENABLE_GEOPOLY \
          sqlite/sqlite3.c \
          -lpthread -ldl -lm \
          -o build/macos-aarch64/sqlite3.dylib

    - name: Compile SQLite for macOS ARM64 (executable)
      run: |
        zig cc -target aarch64-macos-none \
          -O3 \
          -DSQLITE_ENABLE_FTS4 \
          -DSQLITE_ENABLE_FTS5 \
          -DSQLITE_ENABLE_RTREE \
          -DSQLITE_ENABLE_GEOPOLY \
          sqlite/sqlite3.c sqlite/shell.c \
          -lpthread -ldl -lm \
          -o build/macos-aarch64/sqlite3

    - name: Verify all build artifacts
      run: |
        echo "=== Linux x86_64 ==="
        ls -la build/linux-x86_64/
        file build/linux-x86_64/sqlite3.so
        file build/linux-x86_64/sqlite3
        
        echo "=== Windows x86_64 ==="
        ls -la build/windows-x86_64/
        file build/windows-x86_64/sqlite3.dll
        file build/windows-x86_64/sqlite3.exe
        
        echo "=== macOS x86_64 ==="
        ls -la build/macos-x86_64/
        file build/macos-x86_64/sqlite3.dylib
        file build/macos-x86_64/sqlite3
        
        echo "=== macOS ARM64 ==="
        ls -la build/macos-aarch64/
        file build/macos-aarch64/sqlite3.dylib
        file build/macos-aarch64/sqlite3

    - name: Test Linux SQLite executable
      run: |
        build/linux-x86_64/sqlite3 --version