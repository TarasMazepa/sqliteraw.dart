name: sqlite-build.yml

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # Common SQLite compile-time options based on official documentation
  SQLITE_CFLAGS: >-
    -O3
    -DSQLITE_ENABLE_FTS4
    -DSQLITE_ENABLE_FTS5
    -DSQLITE_ENABLE_RTREE
    -DSQLITE_ENABLE_GEOPOLY
  
  # Unix/Linux linking flags
  UNIX_LDFLAGS: "-lpthread -ldl -lm"

jobs:
  sqlite-build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang

    - name: Create build directory
      run: |
        mkdir -p build/linux-x86_64

    # Linux x86_64 build
    - name: Compile SQLite for Linux x86_64 (shared library)
      run: |
        clang \
          -fPIC \
          -shared \
          ${{ env.SQLITE_CFLAGS }} \
          sqlite/sqlite3.c \
          ${{ env.UNIX_LDFLAGS }} \
          -o build/linux-x86_64/sqlite3.so

    - name: Compile SQLite for Linux x86_64 (executable)
      run: |
        clang \
          ${{ env.SQLITE_CFLAGS }} \
          sqlite/sqlite3.c sqlite/shell.c \
          ${{ env.UNIX_LDFLAGS }} \
          -o build/linux-x86_64/sqlite3

    - name: Verify build artifacts
      run: |
        echo "=== Linux x86_64 ==="
        ls -la build/linux-x86_64/
        file build/linux-x86_64/sqlite3.so
        file build/linux-x86_64/sqlite3

    - name: Test Linux SQLite executable
      run: |
        build/linux-x86_64/sqlite3 --version